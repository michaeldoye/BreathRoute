#!/bin/bash

# BreatheRoute Commit Message Hook
# Enforces conventional commit format

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Skip revert commits
if echo "$COMMIT_MSG" | grep -qE "^Revert "; then
    exit 0
fi

# Conventional commit pattern
# type(scope): description
# type: description
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?!?: .{1,100}$"

# Get first line of commit message
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  Invalid commit message format                             ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "Your message: ${YELLOW}$FIRST_LINE${NC}"
    echo ""
    echo -e "Expected format: ${GREEN}<type>(<scope>): <description>${NC}"
    echo ""
    echo -e "Valid types:"
    echo -e "  ${CYAN}feat${NC}     - A new feature"
    echo -e "  ${CYAN}fix${NC}      - A bug fix"
    echo -e "  ${CYAN}docs${NC}     - Documentation only changes"
    echo -e "  ${CYAN}style${NC}    - Formatting, white-space, etc."
    echo -e "  ${CYAN}refactor${NC} - Code change that neither fixes a bug nor adds a feature"
    echo -e "  ${CYAN}perf${NC}     - A code change that improves performance"
    echo -e "  ${CYAN}test${NC}     - Adding missing tests"
    echo -e "  ${CYAN}build${NC}    - Changes to build process"
    echo -e "  ${CYAN}ci${NC}       - Changes to CI configuration"
    echo -e "  ${CYAN}chore${NC}    - Other changes that don't modify src or test files"
    echo -e "  ${CYAN}revert${NC}   - Reverts a previous commit"
    echo ""
    echo -e "Examples:"
    echo -e "  ${GREEN}feat(routes): add exposure score calculation${NC}"
    echo -e "  ${GREEN}fix(auth): handle expired tokens correctly${NC}"
    echo -e "  ${GREEN}docs: update API documentation${NC}"
    echo -e "  ${GREEN}chore(deps): update dependencies${NC}"
    echo ""
    exit 1
fi

# Check message length
MSG_LENGTH=${#FIRST_LINE}
if [ $MSG_LENGTH -gt 100 ]; then
    echo -e "${YELLOW}Warning: Commit message is $MSG_LENGTH characters (recommended max: 100)${NC}"
fi

# Check for ticket reference in body (optional but encouraged)
BODY=$(echo "$COMMIT_MSG" | tail -n +3)
if [ -n "$BODY" ]; then
    if ! echo "$BODY" | grep -qE "BR-[0-9]+"; then
        echo -e "${YELLOW}Tip: Consider adding a ticket reference (e.g., BR-123) in the commit body${NC}"
    fi
fi

echo -e "${GREEN}✓ Commit message format is valid${NC}"
exit 0
