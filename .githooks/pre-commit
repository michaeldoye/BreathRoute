#!/bin/bash

# BreatheRoute Pre-Commit Hook
# Enforces linting and formatting before commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}Running pre-commit checks...${NC}"

# Track if any check fails
FAILED=0

# Get list of staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$' || true)
STAGED_TF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tf$' || true)

# ============================================================================
# Go Checks
# ============================================================================

if [ -n "$STAGED_GO_FILES" ]; then
    echo -e "\n${CYAN}Checking Go files...${NC}"

    # Check if Go is installed
    if ! command -v go &> /dev/null; then
        echo -e "${YELLOW}Warning: Go is not installed, skipping Go checks${NC}"
    else
        # Check formatting with gofmt
        echo -e "  Running gofmt..."
        UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>&1 || true)
        if [ -n "$UNFORMATTED" ]; then
            echo -e "${RED}  ✗ The following files are not formatted:${NC}"
            for file in $UNFORMATTED; do
                echo -e "    - $file"
            done
            echo -e "${YELLOW}  Run 'gofmt -w <file>' or 'make fmt' to fix${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ✓ gofmt passed${NC}"
        fi

        # Check with go vet
        echo -e "  Running go vet..."
        if ! go vet ./... 2>&1; then
            echo -e "${RED}  ✗ go vet found issues${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ✓ go vet passed${NC}"
        fi

        # Run golangci-lint if available
        if command -v golangci-lint &> /dev/null; then
            echo -e "  Running golangci-lint..."
            if ! golangci-lint run --new-from-rev=HEAD~1 --timeout=5m 2>&1; then
                echo -e "${RED}  ✗ golangci-lint found issues${NC}"
                FAILED=1
            else
                echo -e "${GREEN}  ✓ golangci-lint passed${NC}"
            fi
        else
            echo -e "${YELLOW}  Skipping golangci-lint (not installed)${NC}"
            echo -e "${YELLOW}  Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest${NC}"
        fi

        # Run tests for changed packages
        echo -e "  Running tests for changed packages..."
        CHANGED_PACKAGES=$(echo "$STAGED_GO_FILES" | xargs -I{} dirname {} | sort -u | sed 's|^|./|')
        if [ -n "$CHANGED_PACKAGES" ]; then
            if ! go test -short $CHANGED_PACKAGES 2>&1; then
                echo -e "${RED}  ✗ Tests failed${NC}"
                FAILED=1
            else
                echo -e "${GREEN}  ✓ Tests passed${NC}"
            fi
        fi
    fi
fi

# ============================================================================
# Swift Checks
# ============================================================================

if [ -n "$STAGED_SWIFT_FILES" ]; then
    echo -e "\n${CYAN}Checking Swift files...${NC}"

    # Check if SwiftLint is installed
    if ! command -v swiftlint &> /dev/null; then
        echo -e "${YELLOW}Warning: SwiftLint is not installed, skipping Swift linting${NC}"
        echo -e "${YELLOW}Install with: brew install swiftlint${NC}"
    else
        echo -e "  Running SwiftLint..."

        # Run SwiftLint only on staged files
        SWIFTLINT_ERRORS=0
        for file in $STAGED_SWIFT_FILES; do
            if [ -f "$file" ]; then
                if ! swiftlint lint --quiet --path "$file" 2>&1; then
                    SWIFTLINT_ERRORS=1
                fi
            fi
        done

        if [ $SWIFTLINT_ERRORS -eq 1 ]; then
            echo -e "${RED}  ✗ SwiftLint found issues${NC}"
            echo -e "${YELLOW}  Run 'swiftlint --fix' to auto-fix some issues${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ✓ SwiftLint passed${NC}"
        fi
    fi

    # Check for SwiftFormat if available
    if command -v swiftformat &> /dev/null; then
        echo -e "  Running SwiftFormat check..."
        if ! swiftformat --lint $STAGED_SWIFT_FILES 2>&1; then
            echo -e "${RED}  ✗ SwiftFormat found formatting issues${NC}"
            echo -e "${YELLOW}  Run 'swiftformat .' to fix${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ✓ SwiftFormat passed${NC}"
        fi
    fi
fi

# ============================================================================
# Terraform Checks
# ============================================================================

if [ -n "$STAGED_TF_FILES" ]; then
    echo -e "\n${CYAN}Checking Terraform files...${NC}"

    # Check if Terraform is installed
    if ! command -v terraform &> /dev/null; then
        echo -e "${YELLOW}Warning: Terraform is not installed, skipping Terraform checks${NC}"
    else
        # Check formatting
        echo -e "  Running terraform fmt..."
        UNFORMATTED_TF=$(terraform fmt -check -recursive infrastructure 2>&1 || true)
        if [ -n "$UNFORMATTED_TF" ]; then
            echo -e "${RED}  ✗ Terraform files are not formatted${NC}"
            echo -e "${YELLOW}  Run 'terraform fmt -recursive infrastructure' to fix${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ✓ terraform fmt passed${NC}"
        fi

        # Validate Terraform (only if we're in an initialized directory)
        for env_dir in infrastructure/environments/*/; do
            if [ -d "$env_dir/.terraform" ]; then
                echo -e "  Validating $env_dir..."
                if ! (cd "$env_dir" && terraform validate) 2>&1; then
                    echo -e "${RED}  ✗ Terraform validation failed for $env_dir${NC}"
                    FAILED=1
                else
                    echo -e "${GREEN}  ✓ Terraform validation passed for $env_dir${NC}"
                fi
            fi
        done
    fi

    # Run tfsec if available
    if command -v tfsec &> /dev/null; then
        echo -e "  Running tfsec..."
        if ! tfsec infrastructure --soft-fail 2>&1; then
            echo -e "${YELLOW}  ⚠ tfsec found potential security issues (non-blocking)${NC}"
        else
            echo -e "${GREEN}  ✓ tfsec passed${NC}"
        fi
    fi
fi

# ============================================================================
# General Checks
# ============================================================================

echo -e "\n${CYAN}Running general checks...${NC}"

# Check for secrets/credentials in staged files
echo -e "  Checking for potential secrets..."
SECRETS_PATTERN='(password|secret|api_key|apikey|access_token|auth_token|credentials|private_key)\s*[:=]\s*["\x27][^"\x27]{8,}'
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        if grep -iE "$SECRETS_PATTERN" "$file" > /dev/null 2>&1; then
            echo -e "${RED}  ✗ Potential secret found in: $file${NC}"
            echo -e "${YELLOW}  Please review and remove any hardcoded credentials${NC}"
            FAILED=1
        fi
    fi
done

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}  ✓ No secrets detected${NC}"
fi

# Check for large files (>1MB)
echo -e "  Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 1048576 ]; then
            echo "$file ($((SIZE / 1024))KB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}  ⚠ Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES" | while read line; do
        echo -e "    - $line"
    done
    echo -e "${YELLOW}  Consider using Git LFS for large files${NC}"
fi

# Check for TODO/FIXME without ticket reference
echo -e "  Checking for TODOs without ticket references..."
TODO_PATTERN='(TODO|FIXME|XXX|HACK)(?!.*\[BR-[0-9]+\])'
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        if grep -P "$TODO_PATTERN" "$file" > /dev/null 2>&1; then
            echo -e "${YELLOW}  ⚠ TODO without ticket reference in: $file${NC}"
        fi
    fi
done

# ============================================================================
# Final Result
# ============================================================================

echo ""
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  Pre-commit checks FAILED. Please fix issues before commit ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "To bypass this hook (not recommended), use: ${YELLOW}git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║  All pre-commit checks passed!                             ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
    exit 0
fi
