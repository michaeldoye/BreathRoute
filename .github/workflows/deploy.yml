name: Build & Deploy

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - 'infrastructure/**'
      - '*.md'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - 'infrastructure/**'
      - '*.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api
          - worker

env:
  GO_VERSION: '1.22'
  REGION: 'europe-west4'
  REGISTRY: 'europe-west4-docker.pkg.dev'

jobs:
  determine-config:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      project_id: ${{ steps.config.outputs.project_id }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}
      deploy_api: ${{ steps.config.outputs.deploy_api }}
      deploy_worker: ${{ steps.config.outputs.deploy_worker }}
    steps:
      - name: Determine configuration
        id: config
        run: |
          # Determine environment
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          else
            ENV="staging"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Set project ID based on environment
          if [ "$ENV" == "prod" ]; then
            echo "project_id=breatheroute-prod" >> $GITHUB_OUTPUT
          else
            echo "project_id=breatheroute-staging" >> $GITHUB_OUTPUT
          fi

          # Determine if we should deploy
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

          # Determine which services to deploy
          SERVICE="${{ inputs.service }}"
          if [ -z "$SERVICE" ] || [ "$SERVICE" == "all" ]; then
            echo "deploy_api=true" >> $GITHUB_OUTPUT
            echo "deploy_worker=true" >> $GITHUB_OUTPUT
          elif [ "$SERVICE" == "api" ]; then
            echo "deploy_api=true" >> $GITHUB_OUTPUT
            echo "deploy_worker=false" >> $GITHUB_OUTPUT
          else
            echo "deploy_api=false" >> $GITHUB_OUTPUT
            echo "deploy_worker=true" >> $GITHUB_OUTPUT
          fi

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run linter
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

      - name: Run tests
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: coverage.out
          fail_ci_if_error: false

  build-api:
    needs: [determine-config, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-config.outputs.environment }}
    if: needs.determine-config.outputs.deploy_api == 'true'

    permissions:
      contents: read
      id-token: write

    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and push image
        id: build
        env:
          PROJECT_ID: ${{ needs.determine-config.outputs.project_id }}
        run: |
          IMAGE="${{ env.REGISTRY }}/${PROJECT_ID}/breatheroute/api:${{ github.sha }}"

          docker build \
            --build-arg VERSION=${{ github.sha }} \
            --build-arg BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            -t ${IMAGE} \
            -f Dockerfile.api \
            .

          docker push ${IMAGE}

          # Also tag as latest for the environment
          docker tag ${IMAGE} "${{ env.REGISTRY }}/${PROJECT_ID}/breatheroute/api:latest"
          docker push "${{ env.REGISTRY }}/${PROJECT_ID}/breatheroute/api:latest"

          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

  build-worker:
    needs: [determine-config, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-config.outputs.environment }}
    if: needs.determine-config.outputs.deploy_worker == 'true'

    permissions:
      contents: read
      id-token: write

    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and push image
        id: build
        env:
          PROJECT_ID: ${{ needs.determine-config.outputs.project_id }}
        run: |
          IMAGE="${{ env.REGISTRY }}/${PROJECT_ID}/breatheroute/worker:${{ github.sha }}"

          docker build \
            --build-arg VERSION=${{ github.sha }} \
            --build-arg BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            -t ${IMAGE} \
            -f Dockerfile.worker \
            .

          docker push ${IMAGE}

          # Also tag as latest for the environment
          docker tag ${IMAGE} "${{ env.REGISTRY }}/${PROJECT_ID}/breatheroute/worker:latest"
          docker push "${{ env.REGISTRY }}/${PROJECT_ID}/breatheroute/worker:latest"

          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

  deploy-api:
    needs: [determine-config, build-api]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-config.outputs.environment }}
    if: needs.determine-config.outputs.should_deploy == 'true' && needs.determine-config.outputs.deploy_api == 'true'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: breatheroute-api
          region: ${{ env.REGION }}
          image: ${{ needs.build-api.outputs.image }}
          project_id: ${{ needs.determine-config.outputs.project_id }}

      - name: Output service URL
        run: |
          echo "API deployed successfully!"
          echo "Service: breatheroute-api"
          echo "Environment: ${{ needs.determine-config.outputs.environment }}"

  deploy-worker:
    needs: [determine-config, build-worker]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-config.outputs.environment }}
    if: needs.determine-config.outputs.should_deploy == 'true' && needs.determine-config.outputs.deploy_worker == 'true'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: breatheroute-worker
          region: ${{ env.REGION }}
          image: ${{ needs.build-worker.outputs.image }}
          project_id: ${{ needs.determine-config.outputs.project_id }}

      - name: Output service URL
        run: |
          echo "Worker deployed successfully!"
          echo "Service: breatheroute-worker"
          echo "Environment: ${{ needs.determine-config.outputs.environment }}"

  run-migrations:
    needs: [determine-config, deploy-api]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-config.outputs.environment }}
    if: needs.determine-config.outputs.should_deploy == 'true'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Run database migrations
        env:
          PROJECT_ID: ${{ needs.determine-config.outputs.project_id }}
        run: |
          # Option 1: Run migrations via Cloud Run job
          # gcloud run jobs execute breatheroute-migrations \
          #   --region ${{ env.REGION }} \
          #   --project ${PROJECT_ID} \
          #   --wait

          # Option 2: Run via Cloud SQL Auth Proxy (requires additional setup)
          # For now, log that migrations should be run
          echo "Migrations step - implement based on your migration strategy"
          echo "Options:"
          echo "  1. Cloud Run Job for migrations"
          echo "  2. Cloud Build step with SQL Proxy"
          echo "  3. Init container in Cloud Run service"

  notify:
    needs: [determine-config, deploy-api, deploy-worker]
    runs-on: ubuntu-latest
    if: always() && needs.determine-config.outputs.should_deploy == 'true'
    steps:
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.deploy-worker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-config.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
