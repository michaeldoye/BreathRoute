# BreatheRoute Infrastructure

Terraform configuration for BreatheRoute GCP infrastructure.

## Prerequisites

1. [Terraform](https://www.terraform.io/downloads) >= 1.5.0
2. [Google Cloud SDK](https://cloud.google.com/sdk/docs/install) (`gcloud`)
3. GCP project(s) with billing enabled
4. Authenticated with GCP: `gcloud auth application-default login`

## Architecture

```
infrastructure/
├── main.tf                 # Root module - orchestrates all resources
├── variables.tf            # Input variables
├── outputs.tf              # Output values
├── versions.tf             # Provider versions
├── modules/
│   ├── networking/         # VPC, subnets, VPC connector
│   ├── cloud-sql/          # PostgreSQL + PostGIS
│   ├── memorystore/        # Redis cache
│   ├── iam/                # Service accounts & permissions
│   ├── secrets/            # Secret Manager secrets
│   ├── pubsub/             # Topics & subscriptions
│   ├── scheduler/          # Cloud Scheduler jobs
│   └── cloud-run/          # Cloud Run services
└── environments/
    ├── staging/            # Staging environment config
    └── prod/               # Production environment config
```

## Quick Start

### 1. Create GCS bucket for Terraform state

```bash
# Create state bucket (one-time setup)
gcloud storage buckets create gs://breatheroute-terraform-state \
  --location=europe-west4 \
  --uniform-bucket-level-access
```

### 2. Deploy Staging

```bash
cd environments/staging

# Copy and edit variables
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your project ID

# Initialize and deploy
terraform init
terraform plan
terraform apply
```

### 3. Deploy Production

```bash
cd environments/prod

cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars

terraform init
terraform plan
terraform apply
```

## Modules

### networking
- VPC network with private subnet
- VPC Access Connector for Cloud Run
- Private Service Access for Cloud SQL
- Firewall rules

### cloud-sql
- PostgreSQL 15 instance with PostGIS
- Private IP connectivity
- Automated backups with PITR
- Application and migration users

### memorystore
- Redis 7.0 instance
- RDB persistence
- Private connectivity

### iam
- Separate service accounts for API and Worker
- Least-privilege IAM bindings
- Cloud SQL, Secret Manager, Pub/Sub, Logging, Tracing permissions

### secrets
- Database credentials
- JWT signing key
- APNs key for push notifications
- External API keys (Luchtmeetnet, NS, Pollen)
- Webhook signing secret

### pubsub
- Provider refresh topic (hourly data refresh)
- Alert evaluation topic (daily alerts)
- Webhook delivery topic
- GDPR export/deletion topics
- Dead letter topic for failed messages

### scheduler
- Hourly provider refresh
- Daily alert evaluation (5 AM + 8 PM)
- 15-minute provider health checks

### cloud-run
- Generic Cloud Run service module
- VPC connector integration
- Secret Manager integration
- Health probes configured

## Environment Differences

| Resource | Staging | Production |
|----------|---------|------------|
| Cloud SQL | db-f1-micro | db-custom-2-4096 |
| Cloud SQL HA | No | Yes |
| Redis | 1GB Basic | 2GB Standard HA |
| Cloud Run min | 0 | 1 |
| Cloud Run max | 5 | 20 |
| Cloud Run CPU | 1 | 2 |
| Cloud Run Memory | 512Mi | 1Gi |

## Populating Secrets

After Terraform creates the secret placeholders, populate them:

```bash
# Database password (generated by Terraform, stored automatically)
# JWT signing key
echo -n "your-jwt-signing-key" | gcloud secrets versions add breatheroute-staging-jwt-signing-key --data-file=-

# APNs key
gcloud secrets versions add breatheroute-staging-apns-key --data-file=AuthKey_XXXXXXXXXX.p8

# External API keys
echo -n "your-ns-api-key" | gcloud secrets versions add breatheroute-staging-ns-api-key --data-file=-
echo -n "your-pollen-api-key" | gcloud secrets versions add breatheroute-staging-pollen-api-key --data-file=-
```

## CI/CD Integration

GitHub Actions workflows are configured in `.github/workflows/`:

| Workflow | Purpose | Trigger |
|----------|---------|---------|
| `terraform.yml` | Infrastructure deployment | Changes to `infrastructure/` |
| `deploy.yml` | Backend build & deploy | Push to `main`/`develop` |
| `ios.yml` | iOS build & TestFlight | Changes to `ios/` |
| `release.yml` | Coordinated releases | Git tags `v*.*.*` |
| `security.yml` | Security scanning | Weekly + PRs |

### Backend Deployment Flow

1. Push to `develop` → Deploy to staging
2. Push to `main` → Deploy to production
3. Manual dispatch available for selective deployments

### iOS Deployment Flow

1. Push to `develop` → TestFlight (internal)
2. Push to `main` → TestFlight (external)
3. Manual dispatch → App Store submission

### Creating a Release

```bash
# Tag a release (triggers full release workflow)
git tag v1.0.0
git push origin v1.0.0
```

### Required GitHub Secrets

| Secret | Description |
|--------|-------------|
| `GCP_SA_KEY` | GCP service account JSON key |
| `APPLE_BUILD_CERTIFICATE_BASE64` | iOS signing certificate |
| `APPLE_P12_PASSWORD` | Certificate password |
| `APPLE_PROVISIONING_PROFILE_BASE64` | Provisioning profile |
| `APPLE_TEAM_ID` | Apple Developer Team ID |
| `APP_STORE_CONNECT_API_KEY_ID` | App Store Connect API key ID |
| `APP_STORE_CONNECT_API_ISSUER_ID` | App Store Connect issuer ID |
| `APP_STORE_CONNECT_API_KEY_BASE64` | App Store Connect API key |

## Destroying Infrastructure

```bash
# Staging
cd environments/staging
terraform destroy

# Production (careful!)
cd environments/prod
terraform destroy
```

## Jira Tickets Covered

This Terraform configuration covers the following MVP stories:

- **2002**: Set up Cloud SQL (Postgres) + migrations pipeline
- **2003**: Provision Redis cache (Memorystore) and connectivity from Cloud Run
- **2004**: Create service accounts + IAM least privilege for Cloud Run
- **2005**: Secret Manager integration + config conventions
- **2008**: Set up Pub/Sub topics + Cloud Scheduler triggers (jobs)
- **2009**: Define environment separation + deployment runbooks (partial)

Additional infrastructure for:
- **2006**: CI/CD pipeline (Cloud Run services ready for CI/CD deployment)
- **2007**: Observability (IAM permissions for logging/tracing configured)
